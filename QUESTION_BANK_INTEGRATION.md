# NCLEX Question Bank Integration Guide

This document explains how to integrate the Question Bank into your quiz generation system.

## Overview

The Question Bank allows instant quiz delivery by storing and reusing generated questions. Instead of calling the LLM for every question, we:

1. Check the bank for matching questions (instant)
2. Serve bank questions immediately
3. Generate remaining questions via LLM
4. Save newly generated questions to the bank for future use

## Files Created

```
NQBackEnd2/
├── constants/
│   ├── __init__.py
│   └── nclex_classification.py    # NCLEX topic-to-category mapping
│
└── services/
    ├── question_bank.py           # Firebase operations for the bank
    └── quiz_with_bank.py          # Enhanced quiz streamer with bank
```

## How to Enable the Question Bank

### Option 1: Simple Switch (Recommended)

In `services/orchestrator.py`, change ONE line (around line 358):

**Before:**
```python
# Import streaming function
from tools.quiztools import stream_quiz_questions
```

**After:**
```python
# Import streaming function WITH Question Bank integration
from services.quiz_with_bank import stream_quiz_with_bank as stream_quiz_questions
```

That's it! The rest of the code works unchanged because `stream_quiz_with_bank` has the same interface.

### Option 2: Conditional Feature Flag

If you want to enable/disable the Question Bank without code changes:

```python
import os

# Check feature flag
USE_QUESTION_BANK = os.getenv("USE_QUESTION_BANK", "true").lower() == "true"

if USE_QUESTION_BANK:
    from services.quiz_with_bank import stream_quiz_with_bank as stream_quiz_questions
else:
    from tools.quiztools import stream_quiz_questions
```

Then set `USE_QUESTION_BANK=false` in your environment to disable.

## Firebase Setup Required

### 1. Create Firestore Indexes

Go to Firebase Console → Firestore → Indexes and create:

| Collection | Fields | Order |
|------------|--------|-------|
| questionBank | `ldt` (Asc), `status` (Asc) | Collection |
| questionBank | `ldc` (Asc), `status` (Asc) | Collection |
| questionBank | `lang` (Asc), `status` (Asc) | Collection |

### 2. Security Rules (Optional)

If you have Firestore security rules, add:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Question Bank - server-side only
    match /questionBank/{questionId} {
      allow read, write: if false; // Only accessible via Admin SDK
    }
  }
}
```

## How It Works

### Question Retrieval Flow

```
User requests quiz: "4 questions on cardiac medications, medium difficulty"
                                    ↓
    ┌────────────────────────────────────────────────────────┐
    │  Step 1: Check Question Bank                            │
    │  Query: ldt == "en_medium_cardiac medications"          │
    │  Found: 2 questions                                     │
    └────────────────────────────────────────────────────────┘
                                    ↓
    ┌────────────────────────────────────────────────────────┐
    │  Step 2: Deliver Bank Questions (instant!)              │
    │  → Question 1 served immediately                        │
    │  → Question 2 served immediately                        │
    └────────────────────────────────────────────────────────┘
                                    ↓
    ┌────────────────────────────────────────────────────────┐
    │  Step 3: Generate Remaining via LLM                     │
    │  → Question 3 generated by GPT-4                        │
    │  → Question 4 generated by GPT-4                        │
    └────────────────────────────────────────────────────────┘
                                    ↓
    ┌────────────────────────────────────────────────────────┐
    │  Step 4: Save New Questions to Bank (background)        │
    │  → Question 3 saved with composite keys                 │
    │  → Question 4 saved with composite keys                 │
    └────────────────────────────────────────────────────────┘
```

### Firestore Document Structure

Each question in the bank looks like:

```javascript
questionBank/{questionId} = {
  // Question content
  "q": "A patient receiving digoxin reports nausea...",
  "opts": ["A) Continue medication", "B) Hold and notify", ...],
  "ans": "B) Hold and notify the provider",
  "just": "<strong>B is correct</strong> because...",

  // Classification (flat for efficient queries)
  "lang": "en",
  "diff": "medium",
  "topic": "cardiac medications",
  "cat": "PHYS",           // Physiological Integrity
  "subcat": "PHAR",        // Pharmacological Therapies
  "cog": "Analysis",       // Cognitive level

  // Composite keys for fast queries
  "ldt": "en_medium_cardiac medications",  // lang_diff_topic
  "ldc": "en_medium_PHYS_PHAR",            // lang_diff_cat_subcat

  // Metadata
  "src": "generated",
  "chatId": "original_chat_id",
  "status": "active",
  "createdAt": Timestamp,

  // Statistics
  "served": 42,            // Times served to students
  "correct": 31            // Times answered correctly
}
```

### Why Composite Keys?

Firebase doesn't allow complex queries with multiple WHERE clauses efficiently. Instead of:

```python
# Slow - requires composite index and scans
.where("lang", "==", "en")
.where("diff", "==", "medium")
.where("topic", "==", "cardiac medications")
```

We use a single composite key:

```python
# Fast - single field lookup
.where("ldt", "==", "en_medium_cardiac medications")
```

## NCLEX Classification

The `constants/nclex_classification.py` maps nursing topics to NCLEX categories:

```python
from constants.nclex_classification import get_classification

# Example usage
cat, subcat, cognitive = get_classification("cardiac medications")
# Returns: ("PHYS", "PHAR", "Analysis")
```

Categories:
- **SECE**: Safe and Effective Care Environment
  - MC: Management of Care
  - SIC: Safety and Infection Control
- **HPM**: Health Promotion and Maintenance
- **PSYCH**: Psychosocial Integrity
- **PHYS**: Physiological Integrity
  - BC: Basic Care and Comfort
  - PHAR: Pharmacological Therapies
  - RR: Reduction of Risk Potential
  - PA: Physiological Adaptation

## Monitoring the Bank

You can check the bank status programmatically:

```python
from services.question_bank import question_bank

# Get statistics
stats = await question_bank.get_bank_stats()
print(stats)
# {
#   "total_active": 1250,
#   "by_language": {"en": 1000, "fr": 250},
#   "by_category": {"PHYS": 800, "SECE": 300, ...}
# }
```

## Flywheel Effect

As more students use the system:

1. **Week 1**: Most questions generated via LLM (slow, expensive)
2. **Month 1**: 50% from bank, 50% generated (faster, cheaper)
3. **Month 6**: 80%+ from bank (instant, minimal cost)

The bank grows organically with every quiz generated.

## Troubleshooting

### No Questions Coming from Bank

1. Check if questions exist: Query `questionBank` in Firebase Console
2. Verify indexes are created (see Firebase Setup above)
3. Check topic matching - topics are lowercase and must match exactly

### Duplicate Questions Appearing

The deduplication is based on the first 100 characters. For more sophisticated deduplication, you could enhance `_is_duplicate()` in `question_bank.py`.

### Questions Not Being Saved

Check the server logs for errors. Common issues:
- Firebase permissions
- Network connectivity
- Validation errors (missing required fields)
